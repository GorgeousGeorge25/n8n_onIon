---
phase: 05.1-deployable-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/deployer/deploy.ts
  - src/deployer/types.ts
  - cli/deploy.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npm run deploy -- <workflow.ts>` compiles the workflow and imports it into n8n in one command"
    - "The deploy command prints the n8n workflow URL on success"
    - "The deploy command fails gracefully with clear error when n8n is unreachable or API key is missing"
  artifacts:
    - path: "src/deployer/deploy.ts"
      provides: "Programmatic deployWorkflow() function"
      exports: ["deployWorkflow"]
    - path: "src/deployer/types.ts"
      provides: "Deploy result types"
      exports: ["DeployResult"]
    - path: "cli/deploy.ts"
      provides: "CLI deploy command"
    - path: "package.json"
      provides: "deploy script entry"
      contains: "deploy"
  key_links:
    - from: "cli/deploy.ts"
      to: "src/deployer/deploy.ts"
      via: "import deployWorkflow"
      pattern: "import.*deployWorkflow.*from.*deployer"
    - from: "src/deployer/deploy.ts"
      to: "src/compiler/compiler.ts"
      via: "import compileWorkflow"
      pattern: "import.*compileWorkflow.*from.*compiler"
    - from: "src/deployer/deploy.ts"
      to: "n8n API"
      via: "fetch POST /api/v1/workflows"
      pattern: "fetch.*api/v1/workflows"
---

<objective>
Create a deploy command that compiles a workflow .ts file and imports it into n8n via the REST API in a single step.

Purpose: Enable Claude to build and deploy workflows entirely through tool calls — write the .ts file, run `npm run deploy`, done. No manual steps.

Output: `src/deployer/deploy.ts` (programmatic API), `cli/deploy.ts` (CLI command), updated `package.json` with `deploy` script.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/compiler/compiler.ts
@src/compiler/types.ts
@src/compiler/tests/integration.test.ts
@cli/build.ts
@src/index.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployer module with deployWorkflow function</name>
  <files>src/deployer/types.ts, src/deployer/deploy.ts</files>
  <action>
    Create `src/deployer/types.ts` with:
    - `DeployResult` interface: `{ id: string; name: string; url: string; status: number }`
    - `DeployOptions` interface: `{ apiUrl?: string; apiKey?: string; activate?: boolean }`

    Create `src/deployer/deploy.ts` with:
    - `deployWorkflow(builder: WorkflowBuilder, options?: DeployOptions): Promise<DeployResult>` function
    - Uses `compileWorkflow(builder)` from compiler to get JSON
    - Strips `active` field from payload (n8n API rejects it — learned from integration tests)
    - POSTs to `${apiUrl}/api/v1/workflows` with `X-N8N-API-KEY` header
    - Falls back to `process.env.N8N_API_URL` and `process.env.N8N_API_KEY` when options not provided
    - Returns `{ id, name, url: '${apiUrl}/workflow/${id}', status }` on success
    - Throws descriptive errors: "N8N_API_KEY not configured", "n8n not reachable at ${url}", "n8n rejected workflow: ${message}"
    - If `activate` option is true, PATCH `/api/v1/workflows/${id}` with `{ active: true }` after creation

    Pattern to follow: The `importWorkflow()` helper in `src/compiler/tests/integration.test.ts` already does the POST correctly. Extract and generalize that pattern.

    Export both from `src/index.ts` — add `export * from './deployer/types.js'` and `export { deployWorkflow } from './deployer/deploy.js'`.
  </action>
  <verify>
    `npx tsc --noEmit` passes — deployer module type-checks correctly.
    Manually verify: `src/deployer/deploy.ts` imports compileWorkflow, calls fetch with correct headers, handles errors.
  </verify>
  <done>
    `deployWorkflow()` is a callable function that takes a WorkflowBuilder and deploys it to n8n, returning the workflow ID and URL.
    Exported from `src/index.ts`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI deploy command and wire up package.json</name>
  <files>cli/deploy.ts, package.json</files>
  <action>
    Create `cli/deploy.ts` following the pattern of `cli/build.ts`:
    - Usage: `n8n-sdk deploy <workflow.ts> [--activate]`
    - Loads `dotenv/config` for .env support
    - Dynamic imports the workflow .ts file (same as build.ts)
    - Calls `deployWorkflow(builder, { activate })` from deployer module
    - On success: prints workflow name, node count, n8n URL, and "Deployed successfully"
    - On failure: prints error message and exits with code 1
    - Supports `--activate` flag to activate the workflow after import

    Add to `package.json` scripts:
    ```
    "deploy": "tsx cli/deploy.ts"
    ```

    Test the full flow by running: `npm run deploy -- test-workflows/01-webhook-slack.ts`
    This should compile the webhook-slack workflow and import it into n8n.
    Verify the workflow appears in n8n at http://localhost:5678.
    Clean up: delete the test workflow from n8n via API after verification.
  </action>
  <verify>
    1. `npm run deploy -- test-workflows/01-webhook-slack.ts` succeeds and prints workflow URL
    2. The workflow is visible in n8n at the printed URL
    3. `npm run deploy -- nonexistent.ts` fails with clear error
    4. Running without N8N_API_KEY (unset it temporarily) gives "API key not configured" error
    5. Clean up the test workflow after verification
  </verify>
  <done>
    `npm run deploy -- <workflow.ts>` compiles and deploys a workflow to n8n in one command.
    The deployed workflow is functional in n8n.
    Error messages are clear and actionable.
  </done>
</task>

</tasks>

<verification>
Full end-to-end test:
1. `npm run deploy -- test-workflows/01-webhook-slack.ts` — deploys webhook-slack workflow
2. Verify workflow exists in n8n via API: `curl -H "X-N8N-API-KEY: $KEY" http://localhost:5678/api/v1/workflows`
3. `npx tsc --noEmit` — all types check
4. `npm test` — existing tests still pass (no regressions)
5. Clean up deployed test workflow
</verification>

<success_criteria>
- `npm run deploy -- <file.ts>` compiles and deploys to n8n in one command
- Deploy returns workflow URL
- Errors are descriptive (missing API key, n8n unreachable, invalid workflow)
- Existing tests pass (no regressions)
- `deployWorkflow()` available as programmatic API export
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-deployable-package/05.1-01-SUMMARY.md`
</output>
