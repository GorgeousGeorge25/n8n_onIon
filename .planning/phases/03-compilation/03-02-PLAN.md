---
phase: 03-compilation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - cli/build.ts
  - cli/validate.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "CLI build command compiles a workflow .ts file to .json output"
    - "CLI validate command checks workflow structure without producing JSON output"
    - "npm run build-workflow and npm run validate scripts work from package.json"
  artifacts:
    - path: "cli/build.ts"
      provides: "Build CLI command"
      contains: "compileWorkflow"
    - path: "cli/validate.ts"
      provides: "Validate CLI command"
      contains: "validateWorkflow"
    - path: "package.json"
      provides: "npm scripts for build-workflow and validate"
      contains: "build-workflow"
  key_links:
    - from: "cli/build.ts"
      to: "src/compiler/compiler.ts"
      via: "imports compileWorkflow"
      pattern: "import.*compileWorkflow.*compiler"
    - from: "cli/validate.ts"
      to: "src/compiler/validation.ts"
      via: "imports validateWorkflow"
      pattern: "import.*validateWorkflow.*validation"
    - from: "package.json"
      to: "cli/build.ts"
      via: "tsx cli/build.ts script"
      pattern: "tsx cli/build.ts"
---

<objective>
Create CLI commands for building (compiling .ts to .json) and validating workflows, following the existing extract/generate CLI pattern.

Purpose: Exposes the compiler to users via simple CLI commands, completing the developer workflow from code to importable JSON.
Output: cli/build.ts, cli/validate.ts, and package.json script entries.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-compilation/03-01-SUMMARY.md
@cli/extract.ts
@cli/generate.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI build and validate commands</name>
  <files>cli/build.ts, cli/validate.ts</files>
  <action>
Create `cli/build.ts` following the extract.ts/generate.ts pattern:
- Shebang: `#!/usr/bin/env node`
- Import: resolve from 'path', writeFileSync from 'fs', compileWorkflow from '../src/compiler/compiler.js'
- Parse args: `process.argv.slice(2)`, first arg is input .ts path, optional second arg is output .json path
- If no args: print usage `Usage: n8n-sdk build <workflow.ts> [output.json]` and exit(1)
- Resolve input path: `resolve(process.cwd(), args[0])`
- Default output path: input path with .ts replaced by .json
- Dynamic import the workflow module: `await import(inputPath)`
- Get builder from `module.default`
- Validate builder exists and has `name` property (throw if not)
- Call `compileWorkflow(builder)`
- Write JSON with `JSON.stringify(json, null, 2)` to output path
- Print success: node count, connection count
- Wrap in try/catch, print error and exit(1) on failure

Create `cli/validate.ts` following the same pattern:
- Shebang: `#!/usr/bin/env node`
- Import: resolve from 'path', validateWorkflow from '../src/compiler/validation.js'
- Parse args, require input path
- Usage: `Usage: n8n-sdk validate <workflow.ts>`
- Dynamic import workflow module, get builder from default
- Call `builder.getNodes()` and `builder.getConnections()`
- Call `validateWorkflow(nodes, connections)`
- Print success: node count, connection count, "All node references resolved"
- Wrap in try/catch, print validation failure and exit(1)
  </action>
  <verify>Check files exist and have correct structure: `head -5 cli/build.ts cli/validate.ts`</verify>
  <done>cli/build.ts and cli/validate.ts exist, follow extract/generate pattern, import from compiler modules.</done>
</task>

<task type="auto">
  <name>Task 2: Add package.json scripts and verify end-to-end</name>
  <files>package.json</files>
  <action>
Add two new scripts to package.json:
- `"build-workflow": "tsx cli/build.ts"` (not "build" -- that's already tsc)
- `"validate": "tsx cli/validate.ts"`

Verify the CLI scripts at least parse correctly by running them with no args (should print usage and exit 1, not crash with import errors):
- `npx tsx cli/build.ts` should print usage message
- `npx tsx cli/validate.ts` should print usage message

Also run `npx tsc --noEmit` to ensure TypeScript compilation succeeds with the new files.
  </action>
  <verify>
Run `cd /Users/jurissleiners/MyPrograms/n8n_onIon && npx tsx cli/build.ts 2>&1; echo "---"; npx tsx cli/validate.ts 2>&1; echo "---"; npx tsc --noEmit`
Both CLI commands should print usage (not crash). TypeScript should compile clean.
  </verify>
  <done>package.json has build-workflow and validate scripts. Both CLI commands print usage when called with no args. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `npx tsx cli/build.ts` prints usage and exits 1
2. `npx tsx cli/validate.ts` prints usage and exits 1
3. `npx tsc --noEmit` succeeds
4. `npx vitest run` -- all tests still pass
</verification>

<success_criteria>
- cli/build.ts compiles workflow .ts to .json via compileWorkflow()
- cli/validate.ts checks workflow structure via validateWorkflow()
- package.json has build-workflow and validate scripts
- No TypeScript errors, no test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-compilation/03-02-SUMMARY.md`
</output>
