---
phase: 05.2-complex-workflow-builder
plan: 02
type: execute
wave: 2
depends_on: ["05.2-01"]
files_modified:
  - src/compiler/layout.ts
  - src/compiler/validation.ts
autonomous: true

must_haves:
  truths:
    - "Nodes are positioned based on graph topology: triggers left, linear chains flow right, branches fan out vertically, merges converge"
    - "Validation catches missing triggers, orphan nodes, invalid output indices, and missing expression ref targets as errors"
    - "Validation reports missing credentials as warnings (not errors)"
    - "Validation collects all issues before returning (does not fail on first)"
    - "Errors block compilation, warnings do not"
  artifacts:
    - path: "src/compiler/layout.ts"
      provides: "Topology-aware layout using BFS from triggers"
      min_lines: 50
    - path: "src/compiler/validation.ts"
      provides: "Validation with errors/warnings, trigger check, orphan check, output index check, credential warning, expression ref check"
      min_lines: 80
  key_links:
    - from: "src/compiler/compiler.ts"
      to: "src/compiler/validation.ts"
      via: "validateWorkflow call before compilation"
      pattern: "validateWorkflow|ValidationResult"
    - from: "src/compiler/compiler.ts"
      to: "src/compiler/layout.ts"
      via: "Layout function receives nodes and connections"
      pattern: "calculateTopologyPosition|layoutNodes"
---

<objective>
Replace the naive grid layout with topology-aware node positioning, and extend validation from basic connection checks to comprehensive workflow correctness checking.

Purpose: The layout ensures workflows are readable in the n8n canvas. The validation catches common mistakes before compilation, preventing silent failures at deploy time.

Output: Rewritten layout.ts with graph-based positioning, rewritten validation.ts with collect-all error/warning reporting, updated compiler.ts to use new validation return type.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.2-complex-workflow-builder/05.2-01-SUMMARY.md

@src/compiler/layout.ts
@src/compiler/validation.ts
@src/compiler/compiler.ts
@src/builder/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Topology-aware layout engine</name>
  <files>
    src/compiler/layout.ts
    src/compiler/compiler.ts
  </files>
  <action>
Replace the naive grid layout in `src/compiler/layout.ts` with a topology-aware layout algorithm.

**Algorithm:**

1. Build adjacency list from connections (from -> [to, to, ...]).
2. Identify root nodes (nodes with no incoming connections — these are triggers/manual triggers).
3. BFS from roots to assign each node a "depth" (column). Depth 0 = triggers, depth 1 = first action, etc.
4. Within each depth level, assign vertical positions (rows). Spread nodes evenly.
5. Handle merge nodes: a merge node's depth = max(depth of all inputs) + 1 (so it appears after all its sources).

**Layout constants:**
- `SPACING_X = 300` (horizontal between columns)
- `SPACING_Y = 150` (vertical between rows in same column)
- `START_X = 250` (left margin)
- `START_Y = 300` (top margin)

**Export a new function:**
```typescript
export function calculateTopologyPositions(
  nodes: WorkflowNode[],
  connections: WorkflowConnection[]
): Map<string, [number, number]>
```

Returns a map from node name to [x, y] position. Keep the old `calculateGridPosition` exported for backward compatibility but mark it as deprecated.

**Update compiler.ts:** In the node mapping loop, instead of `calculateGridPosition(index)`, look up position from the topology map: `positions.get(node.name) ?? [START_X, START_Y]`.

**Edge cases:**
- Orphan nodes (no connections): place them in a final column to the right.
- Multiple root nodes: stack them vertically at depth 0.
- Cycles (shouldn't happen in n8n but be defensive): treat back-edges as not incrementing depth.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Manual inspection: create a test workflow with branching (IF -> true/false) and verify the positions make visual sense (trigger at left, IF to its right, branches stacked vertically).
  </verify>
  <done>
    - Layout assigns positions based on graph depth from triggers
    - Triggers at left (depth 0), downstream nodes flow right
    - Branches fan out vertically at same depth
    - Merge nodes positioned after all their inputs
    - Orphan nodes get valid positions (not overlapping)
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive validation with collect-all errors and warnings</name>
  <files>
    src/compiler/validation.ts
    src/compiler/compiler.ts
  </files>
  <action>
Rewrite `src/compiler/validation.ts` to implement comprehensive collect-all validation.

**New types (add to validation.ts or compiler/types.ts):**

```typescript
export interface ValidationIssue {
  type: 'error' | 'warning';
  code: string;
  message: string;
  node?: string;  // which node is affected
}

export interface ValidationResult {
  valid: boolean;       // true if no errors (warnings are OK)
  errors: ValidationIssue[];
  warnings: ValidationIssue[];
}
```

**Validation checks to implement:**

1. **Trigger exists** (error, code: `NO_TRIGGER`): At least one node must have a type containing `trigger` or `webhook` (case-insensitive check on node type string). If no trigger found, add error.

2. **No orphan nodes** (error, code: `ORPHAN_NODE`): Every non-trigger node must have at least one incoming connection. Trigger nodes must have at least one outgoing connection (unless workflow has only one node). Nodes with no connections at all are orphans.

3. **Connection references valid** (error, code: `INVALID_CONNECTION`): Keep the existing check — from/to must reference existing node names.

4. **Output index valid for node type** (error, code: `INVALID_OUTPUT_INDEX`): If a connection uses `outputIndex > 0`, verify the source node type supports multiple outputs. Known multi-output types: `n8n-nodes-base.if` (2 outputs), `n8n-nodes-base.switch` (variable). For now, check output index against known patterns. If node type is unknown, allow any outputIndex (don't block).

5. **Credentials exist warning** (warning, code: `MISSING_CREDENTIALS`): If a node has `credentials` set, emit a warning reminding that credential IDs must exist in the target n8n instance. This is a reminder, not a validation failure.

6. **Expression ref targets exist** (error, code: `INVALID_REF`): Scan all node parameters for strings matching the pattern `$node['NodeName']` or `$node["NodeName"]`. Extract the node name and verify it exists in the workflow. If not, emit error.

**Change `validateWorkflow` signature:**

```typescript
export function validateWorkflow(
  nodes: WorkflowNode[],
  connections: WorkflowConnection[]
): ValidationResult
```

**Update compiler.ts:** Instead of `validateWorkflow(nodes, connections)` (which used to throw), now:
```typescript
const validation = validateWorkflow(nodes, connections);
if (!validation.valid) {
  const errorMessages = validation.errors.map(e => `[${e.code}] ${e.message}`).join('\n');
  throw new Error(`Workflow validation failed:\n${errorMessages}`);
}
// Warnings are logged but don't block compilation
if (validation.warnings.length > 0) {
  console.warn('Workflow warnings:', validation.warnings.map(w => `[${w.code}] ${w.message}`).join(', '));
}
```

**Also export `ValidationResult` and `ValidationIssue` from `src/index.ts`.**

**Backward compatibility:** The old `validateWorkflow` threw on error. The new one returns a result. The compiler still throws (by checking `validation.valid`), so external code calling `compileWorkflow` sees the same behavior. But code directly calling `validateWorkflow` now gets a result object instead of void/throw. Update any direct callers.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Run `npx vitest run src/compiler/tests/compiler.test.ts` — existing validation tests will need updating since validateWorkflow now returns ValidationResult instead of throwing. Update the test expectations: instead of `expect(() => validateWorkflow(...)).toThrow(...)`, use `expect(validateWorkflow(...).valid).toBe(false)` and check errors array.
  </verify>
  <done>
    - Validation returns ValidationResult with errors[] and warnings[]
    - Checks: trigger exists, no orphans, valid connections, valid output index, credential warnings, expression ref targets
    - Errors block compilation, warnings don't
    - Compiler uses new validation result (throws on errors, warns on warnings)
    - Existing compiler tests updated to match new validation API
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run src/compiler/tests/compiler.test.ts` — updated validation tests pass
- Layout produces visually sensible positions for branching workflows
- Validation catches all 6 check categories
</verification>

<success_criteria>
- Topology-aware layout positions nodes by graph depth
- Validation collects all issues (errors + warnings)
- Errors block compilation, warnings do not
- 6 validation checks implemented: trigger, orphans, connections, output index, credentials, expression refs
- Compiler updated to use both new layout and new validation
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-complex-workflow-builder/05.2-02-SUMMARY.md`
</output>
