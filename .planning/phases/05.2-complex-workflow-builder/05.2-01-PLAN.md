---
phase: 05.2-complex-workflow-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/builder/types.ts
  - src/builder/workflow.ts
  - src/compiler/types.ts
  - src/compiler/compiler.ts
  - src/schema/types.ts
autonomous: true

must_haves:
  truths:
    - "Compiled nodes have correct typeVersion from schemas (IF=2, Set=3, httpRequest=4, etc.) instead of hardcoded 1"
    - "connect() accepts inputIndex parameter and compiled connections emit correct index values"
    - "Nodes can have credentials attached; compiled JSON includes credentials field"
    - "Error connections are emitted separately from main connections in compiled JSON"
  artifacts:
    - path: "src/builder/types.ts"
      provides: "WorkflowNode with credentials field, WorkflowConnection with inputIndex and connectionType"
    - path: "src/compiler/compiler.ts"
      provides: "Compiler reads typeVersion from schema registry, emits credentials, emits inputIndex, emits error connections"
  key_links:
    - from: "src/compiler/compiler.ts"
      to: "schemas/*.json"
      via: "Schema registry lookup for typeVersion by node type"
      pattern: "typeVersion.*schema|defaultVersion"
    - from: "src/compiler/compiler.ts"
      to: "src/builder/types.ts"
      via: "WorkflowConnection.inputIndex -> N8nConnection.index"
      pattern: "conn\\.inputIndex|index.*inputIndex"
---

<objective>
Extend the builder types and compiler to support four core complex workflow patterns: correct typeVersion from node schemas, inputIndex on connections for merge/fan-in, credential attachment per node, and error-handling connection types.

Purpose: These four changes are the foundation for all other Phase 5.2 work. Without correct typeVersions, credentials, inputIndex, and error connections, the compiler cannot produce real-world workflows.

Output: Updated builder types, workflow builder, compiler types, and compiler that handle all four patterns. Existing tests may break due to typeVersion change (expected — snapshot regeneration is in Plan 03).
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-deployable-package/05.1-01-SUMMARY.md

@src/builder/types.ts
@src/builder/workflow.ts
@src/compiler/types.ts
@src/compiler/compiler.ts
@src/schema/types.ts
@src/schema/cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add typeVersion schema registry and extend builder/compiler types</name>
  <files>
    src/schema/types.ts
    src/builder/types.ts
    src/compiler/types.ts
    src/compiler/compiler.ts
  </files>
  <action>
**Schema registry for typeVersion:**

Create a synchronous typeVersion lookup that the compiler can use. The schemas are already cached as JSON files in `schemas/`. Build a lightweight registry:

1. In a new file `src/compiler/schema-registry.ts`, create:
   - `loadSchemaRegistry()` — async function that reads all schema JSON files from `schemas/` directory, extracts `defaultVersion` (or max of `version` array if `defaultVersion` is absent) for each node type, and returns a `Map<string, number>` mapping node type string to typeVersion number.
   - `let cachedRegistry: Map<string, number> | null = null` — module-level cache so it loads once.
   - `getTypeVersion(nodeType: string): number` — synchronous lookup returning cached typeVersion, falls back to `1` if not found. Throw if registry not loaded (caller must await `loadSchemaRegistry()` first).

2. In `src/schema/types.ts`, add `defaultVersion?: number` to the `N8nNodeType` interface (the field exists in schema JSON but is not in the TypeScript type).

**Builder types — extend WorkflowNode and WorkflowConnection:**

3. In `src/builder/types.ts`:
   - Add `credentials?: Record<string, { id: string; name: string }>` to `WorkflowNode` interface. This matches n8n's credential format: keys are credential type names (e.g., `slackApi`), values have `id` and `name`.
   - Add `inputIndex?: number` to `WorkflowConnection` interface (default 0 if unset).
   - Add `connectionType?: 'main' | 'error'` to `WorkflowConnection` interface (default 'main' if unset).

4. In `WorkflowBuilder` interface, update `connect()` signature:
   - `connect(from: NodeRef, to: NodeRef, outputIndex?: number, inputIndex?: number): void`
   - Add `connectError(from: NodeRef, to: NodeRef): void` — creates a connection with `connectionType: 'error'`, `outputIndex: 0`, `inputIndex: 0`.

**Compiler types — extend N8nNode:**

5. In `src/compiler/types.ts`:
   - Add `credentials?: Record<string, { id: string; name: string }>` to `N8nNode` interface.

**Update compiler to use all new fields:**

6. In `src/compiler/compiler.ts`:
   - Change `compileWorkflow` to `async compileWorkflow` (needs async for schema registry load).
   - At the top of `compileWorkflow`, call `await loadSchemaRegistry()` to ensure registry is loaded.
   - In the node mapping, replace `typeVersion: 1` with `typeVersion: getTypeVersion(node.type)`.
   - In the node mapping, if `node.credentials` is defined and non-empty, add `credentials: node.credentials` to the N8nNode output.
   - In the connection loop, use `conn.inputIndex ?? 0` instead of hardcoded `0` for the connection `index` field.
   - For error connections (`connectionType === 'error'`), emit them under a separate key in the connections object. n8n format for error connections: the source node entry should have an additional key alongside `main` — but actually n8n uses a different approach: error connections go in `connections[sourceName]` with `type: 'error'` instead of `type: 'main'`. Research note: Actually, in n8n, error handler connections work differently — they are NOT in the connections object. Instead, n8n uses the `onError` setting on the node that can fail, plus `errorWorkflow` settings. HOWEVER, the more practical approach for SDK v1.1 is: use the n8n error trigger node (`n8n-nodes-base.errorTrigger`) pattern, which is a workflow-level error handler, not per-node error connections. For NOW, implement per-node error connections using the `connections` object with a `type` field approach — the compiler should group connections by `connectionType` and emit them in the appropriate structure. The key insight: in n8n JSON, error connections don't appear in the main connections object at all — they're handled by `settings.errorWorkflow` or node-level `onError` property. So for this task, implement error connections as: when a node has an error connection from it, add `onError: "continueErrorOutput"` to that node's parameters, and the error output goes to `main[lastOutputIndex+1]` (n8n uses the last output as error output when `onError` is set). This is how n8n actually handles inline error paths in the visual editor.

**Important: Making compileWorkflow async is a breaking change.** Update `src/deployer/deploy.ts` and `src/index.ts` to handle the async change. The deployer already uses `await` patterns so the change is minimal — just add `await` before `compileWorkflow(builder)` in `deploy.ts`.
  </action>
  <verify>
    Run `npx tsc --noEmit` — should compile without type errors (tests may fail at runtime due to typeVersion changes, that's expected).
  </verify>
  <done>
    - N8nNodeType has defaultVersion field
    - WorkflowNode has credentials, WorkflowConnection has inputIndex and connectionType
    - N8nNode has credentials field
    - Compiler reads typeVersion from schema registry (async)
    - Compiler emits inputIndex from connections
    - Compiler emits credentials from nodes
    - Error connections emit onError parameter and use appropriate output index
    - compileWorkflow is async; deployer updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Update workflow builder to support new connect signatures and credentials</name>
  <files>
    src/builder/workflow.ts
  </files>
  <action>
Update the workflow builder implementation in `src/builder/workflow.ts`:

1. **connect() with inputIndex:** Change `connect(from, to, outputIndex = 0)` to `connect(from, to, outputIndex = 0, inputIndex = 0)`. Store `inputIndex` in the WorkflowConnection.

2. **connectError():** Add `connectError(from, to)` method that pushes a connection with `{ from: from.name, to: to.name, outputIndex: 0, inputIndex: 0, connectionType: 'error' }`.

3. **credentials on trigger/node:** Both `trigger()` and `node()` should accept an optional 4th parameter for credentials: `trigger(name, type, parameters, credentials?)` and `node(name, type, parameters, credentials?)`. Store it on the WorkflowNode. Keep the API backward-compatible — credentials is optional.

4. **Update the internal `addNode` helper** to accept and store `credentials` on WorkflowNode.

Keep the API backward-compatible. All existing code that calls `wf.trigger('X', 'type', {})` and `wf.connect(a, b)` should continue to work unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` — TypeScript compilation passes. Run `npx vitest run src/builder/tests/workflow.test.ts` — existing builder tests still pass (they don't check typeVersion or credentials, so they should pass).
  </verify>
  <done>
    - `connect(from, to, outputIndex, inputIndex)` stores inputIndex
    - `connectError(from, to)` creates error-type connection
    - `trigger()` and `node()` accept optional credentials parameter
    - All changes are backward-compatible
    - Existing builder tests pass
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (no type errors)
- `npx vitest run src/builder/tests/workflow.test.ts` — existing builder tests pass
- Snapshot tests WILL fail (typeVersion changed from 1 to real values) — this is expected and fixed in Plan 03
</verification>

<success_criteria>
- Builder types support credentials, inputIndex, connectionType
- Compiler reads typeVersion from schemas (async)
- Compiler emits credentials, inputIndex, and error connections
- TypeScript compiles cleanly
- Existing builder tests pass (non-snapshot tests)
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-complex-workflow-builder/05.2-01-SUMMARY.md`
</output>
