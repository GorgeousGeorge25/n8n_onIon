---
phase: 05.2-complex-workflow-builder
plan: 01
subsystem: compiler
tags: [schema-registry, typeVersion, inputIndex, error-handling, async]

# Dependency graph
requires:
  - phase: 05.1-deployable-package
    provides: Deployer infrastructure with API integration
  - phase: 03-compiler
    provides: Basic compiler with hardcoded typeVersion
provides:
  - Schema registry for typeVersion lookup from cached schemas
  - Builder support for inputIndex (merge/fan-in patterns)
  - Builder support for error connections (error-handling flows)
  - Async compiler with correct typeVersion per node type
affects: [05.2-02, 05.2-03, 05.2-04, snapshot-regeneration, layout, validation]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Schema registry pattern for cached JSON metadata
    - Async compiler pattern for schema loading
    - Backward-compatible API extensions with optional parameters

key-files:
  created:
    - src/compiler/schema-registry.ts
  modified:
    - src/schema/types.ts
    - src/builder/types.ts
    - src/builder/workflow.ts
    - src/compiler/types.ts
    - src/compiler/compiler.ts
    - src/deployer/deploy.ts
    - src/index.ts
    - cli/build.ts

key-decisions:
  - "Fall back to typeVersion 1 if schema not found (graceful degradation)"
  - "Cache schema registry on first load (performance optimization)"
  - "Add onError parameter to nodes with error connections (n8n requirement)"
  - "Make compiler async to support schema registry loading"

patterns-established:
  - "Module-level caching pattern for expensive operations"
  - "Optional parameters with defaults for backward compatibility"
  - "Explicit error throwing when registry not loaded (fail-fast)"

# Metrics
duration: 6min
completed: 2026-01-31
---

# Phase 05.2 Plan 01: Compiler Correctness Foundation Summary

**Schema registry with typeVersion lookup, inputIndex for merge patterns, and error connection support - silent correctness bug fixed**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-31T21:01:23Z
- **Completed:** 2026-01-31T21:07:23Z
- **Tasks:** 3
- **Files modified:** 12

## Accomplishments

- Fixed silent typeVersion bug: compiler now reads defaultVersion from schemas (IF=2.3, Set=3, httpRequest=4) instead of hardcoded 1
- Added inputIndex support to builder and compiler for merge/fan-in workflow patterns
- Added error connection support with connectError() API and automatic onError parameter injection
- Made compiler async to support schema registry loading

## Task Commits

Each task was committed atomically:

1. **Task 1: Schema registry for typeVersion lookup** - `706c743` (feat)
2. **Task 2: Extend builder types and workflow builder for inputIndex and error connections** - `96064f0` (feat)
3. **Task 3: Update compiler for typeVersion, inputIndex, and error connections** - `b8c0429` (feat)

## Files Created/Modified

- `src/compiler/schema-registry.ts` - Schema registry that loads cached schemas once, extracts typeVersion, provides getTypeVersion() lookup
- `src/schema/types.ts` - Added defaultVersion field to N8nNodeType interface
- `src/builder/types.ts` - Added inputIndex and connectionType to WorkflowConnection, updated connect() signature, added connectError() method
- `src/builder/workflow.ts` - Implemented inputIndex parameter and connectError() method with node existence validation
- `src/compiler/types.ts` - Updated N8nWorkflow connections to support both main and error arrays
- `src/compiler/compiler.ts` - Made async, loads schema registry, reads typeVersion per node, emits inputIndex, handles error connections with onError parameter
- `src/deployer/deploy.ts` - Updated to await async compileWorkflow
- `src/index.ts` - Exported schema registry functions
- `cli/build.ts` - Updated to await compileWorkflow and count error connections
- `src/compiler/tests/*.test.ts` - Updated all tests to await async compileWorkflow, added null assertions for optional connection arrays

## Decisions Made

1. **Fall back to typeVersion 1 if schema not found** - Graceful degradation prevents compilation failures if schema cache is incomplete
2. **Cache schema registry on module load** - Performance optimization: expensive JSON parsing happens once per process lifetime
3. **Add onError parameter automatically** - When error connections exist, compiler adds `onError: "continueErrorOutput"` to source node parameters (n8n requirement)
4. **Make compiler async** - Breaking change from sync to async, but necessary to load schema registry. Deployer already async, so minimal impact.
5. **Backward-compatible builder API** - inputIndex and connectionType are optional parameters with defaults (0 and 'main'), so existing code works unchanged

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all three tasks completed without blockers.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for next plans:**
- Schema registry loaded and tested
- Builder API extended with backward compatibility
- Compiler async pattern established
- typeVersion now correct for all nodes

**Expected impact:**
- Snapshot tests WILL fail (typeVersion changed from 1 to real values) - fixed in Plan 04
- Existing integration tests should continue to pass (compiled workflows now have correct typeVersions)
- Future plans can use inputIndex for merge nodes and connectError() for error handling flows

**Blockers/Concerns:**
- None - this was the low-risk, high-value foundation plan

---
*Phase: 05.2-complex-workflow-builder*
*Completed: 2026-01-31*
