---
phase: 05.2-complex-workflow-builder
plan: 03
subsystem: compiler
tags: [layout, validation, topology, graph-algorithms, error-handling]

requires:
  - 05.2-01: Schema registry for typeVersion
  - 05.2-02: Credentials support in compiler

provides:
  - topology-aware layout positioning nodes by graph depth
  - comprehensive validation with errors and warnings
  - six validation checks covering common workflow mistakes
  - collect-all error reporting (doesn't fail on first issue)

affects:
  - 05.2-04: Snapshot tests will reflect new positions

tech-stack:
  added: []
  patterns:
    - BFS graph traversal for layout depth assignment
    - Collect-all validation pattern (errors vs warnings)
    - Expression reference extraction via regex on JSON-stringified params

key-files:
  created: []
  modified:
    - src/compiler/layout.ts
    - src/compiler/validation.ts
    - src/compiler/types.ts
    - src/compiler/compiler.ts
    - src/compiler/tests/compiler.test.ts
    - src/index.ts

decisions:
  - title: BFS-based topology layout
    context: Naive grid layout produced overlapping nodes in complex workflows
    choice: Use BFS from triggers to assign depth-based columns
    rationale: Triggers at left, downstream flows right, branches fan vertically

  - title: Validation returns result object instead of throwing
    context: Old API threw on first error, new API needed to collect all issues
    choice: Return ValidationResult with errors[] and warnings[]
    rationale: Allows reporting all issues at once, distinguishes blocking errors from informational warnings

  - title: Credentials generate warnings not errors
    context: Credential IDs are external to workflow definition
    choice: MISSING_CREDENTIALS is warning type, doesn't block compilation
    rationale: Compiler can't verify credential existence, deployment will handle missing credentials

  - title: Expression reference validation via JSON.stringify
    context: Need to find $node["Name"] references in nested parameter objects
    choice: Stringify parameters and use regex to extract node names
    rationale: Simple approach that handles arbitrary nesting without tree traversal

metrics:
  duration: 4m 29s
  completed: 2026-01-31
---

# Phase 5.2 Plan 03: Layout and Validation Enhancement Summary

**One-liner:** BFS topology layout positions nodes by graph depth; comprehensive validation collects 6 error/warning categories before compilation

## What Was Built

Upgraded the compiler's layout engine from naive grid positioning to topology-aware graph-based layout, and extended validation from basic connection checks to comprehensive workflow correctness verification with collect-all error/warning reporting.

### Layout Engine (Task 1)

**Algorithm:**
1. Build adjacency lists (incoming/outgoing) from connections
2. Identify root nodes (triggers - nodes with no incoming connections)
3. BFS from roots to assign each node a depth (column number)
4. Handle merge nodes: depth = max(all input depths) + 1
5. Position nodes within each depth level vertically with fixed spacing
6. Orphan nodes (unreachable from triggers) go in final column to the right

**Layout constants:**
- SPACING_X = 300 (horizontal between columns)
- SPACING_Y = 150 (vertical between rows)
- START_X = 250, START_Y = 300

**Key behaviors:**
- Triggers positioned at left (depth 0)
- Linear chains flow left-to-right
- Branches fan out vertically at same depth
- Merge nodes appear after all their inputs converge
- Defensive against cycles (visited set prevents infinite loops)

**Backward compatibility:**
- Kept `calculateGridPosition` exported (marked deprecated)
- New `calculateTopologyPositions` exported from index.ts

### Validation Engine (Task 2)

**New types:**
```typescript
interface ValidationIssue {
  type: 'error' | 'warning';
  code: string;
  message: string;
  node?: string;
}

interface ValidationResult {
  valid: boolean; // true if no errors (warnings OK)
  errors: ValidationIssue[];
  warnings: ValidationIssue[];
}
```

**Six validation checks:**

1. **NO_TRIGGER (error):** Workflow must have at least one trigger or webhook node
2. **ORPHAN_NODE (error):** All non-trigger nodes need incoming connections; triggers need outgoing (unless single-node workflow)
3. **INVALID_CONNECTION (error):** Connection from/to must reference existing node names
4. **INVALID_OUTPUT_INDEX (error):** Output index must be valid for node type (e.g., IF node supports 0-1, Switch supports many)
5. **MISSING_CREDENTIALS (warning):** Reminds that credential IDs must exist in target n8n instance
6. **INVALID_REF (error):** Expression `$node["Name"]` references must target existing nodes

**Collect-all behavior:**
- Validation runs all checks before returning
- Accumulates all errors and warnings
- Returns single ValidationResult with complete issue list
- Errors block compilation, warnings do not

**Integration with compiler:**
```typescript
const validation = validateWorkflow(nodes, connections);
if (!validation.valid) {
  throw new Error(`Workflow validation failed:\n${errorMessages}`);
}
if (validation.warnings.length > 0) {
  console.warn('Workflow warnings:', ...);
}
```

### Test Updates

Updated compiler tests to match new ValidationResult API:
- Changed from `expect(() => validateWorkflow(...)).toThrow(...)` to `expect(validateWorkflow(...).valid).toBe(false)`
- Added tests for new validation checks: NO_TRIGGER, ORPHAN_NODE, MISSING_CREDENTIALS, INVALID_REF
- Fixed tests that created unconnected nodes (now triggers orphan errors)
- Updated typeVersion expectation (schema registry returns 2.4, not 1)

## Technical Decisions

### BFS Graph Traversal

**Problem:** Naive grid layout positioned nodes in 3-row grid pattern regardless of workflow structure, causing visual confusion in branching/merging workflows.

**Solution:** BFS traversal from trigger nodes assigns each node a "depth" representing its distance from workflow start. Depth becomes X-coordinate column.

**Why BFS:**
- Guarantees shortest path (minimal depth) from triggers
- Handles multiple roots (multiple triggers)
- Handles merge nodes (max of input depths)
- Simple to implement with queue

### Validation Pattern: Errors vs Warnings

**Design choice:** Distinguish between blocking issues (errors) and informational issues (warnings).

**Errors block compilation:**
- NO_TRIGGER: Can't run workflow without trigger
- ORPHAN_NODE: Node will never execute
- INVALID_CONNECTION: Reference to non-existent node
- INVALID_OUTPUT_INDEX: Invalid output for node type
- INVALID_REF: Expression references non-existent node

**Warnings inform but don't block:**
- MISSING_CREDENTIALS: Credential existence verified at deploy time, not compile time

**Benefit:** User sees all issues at once, can fix multiple problems in one iteration.

### Expression Reference Extraction

**Challenge:** Find `$node["Name"]` references in arbitrarily nested parameter objects.

**Solution:** `JSON.stringify(node.parameters)` + regex `/\$node\[\\?"?([^\]\\""'']+)\\?"?\]/g`

**Why this works:**
- JSON.stringify flattens nesting into single string
- In JSON, quotes are escaped as `\"`
- Regex matches both escaped and unescaped quotes
- Extracts node name from capture group

**Alternative considered:** Recursive tree traversal of parameter object. Rejected as more complex.

## Deviations from Plan

None - plan executed exactly as written.

## Testing

**Test coverage:**
- ✅ All 13 compiler tests pass
- ✅ TypeScript compilation passes (`npx tsc --noEmit`)
- ✅ Layout produces unique positions for 5-node workflow
- ✅ Validation catches all 6 check categories
- ✅ Validation returns collect-all results

**Test changes required:**
- Updated typeVersion expectation (1 → variable, now accepts any positive number)
- Added connections to orphan nodes in UUID and layout tests
- Updated validation tests from throw-based to ValidationResult-based API

## Files Changed

| File | Lines Changed | Description |
|------|---------------|-------------|
| src/compiler/layout.ts | +133 | Added calculateTopologyPositions with BFS algorithm |
| src/compiler/validation.ts | +157 | Rewrote with ValidationResult return, 6 checks |
| src/compiler/types.ts | +17 | Added ValidationIssue, ValidationResult interfaces |
| src/compiler/compiler.ts | +12 | Use topology positions, handle ValidationResult |
| src/compiler/tests/compiler.test.ts | +80 | Updated for new API, added 5 validation tests |
| src/index.ts | +1 | Export calculateTopologyPositions |

**Total:** ~400 lines changed

## Next Phase Readiness

**Ready for 05.2-04 (Snapshot Tests):**
- ✅ Layout produces deterministic positions
- ✅ Validation catches malformed workflows before compilation
- ⚠️ Snapshot tests will need regeneration due to position changes

**Blockers/Concerns:**
- Snapshot files will show position differences (expected, not a blocker)
- Any existing snapshots expecting typeVersion=1 will need updating

## Performance Notes

**Execution time:** 4 minutes 29 seconds

**Algorithm complexity:**
- Layout: O(N + E) where N=nodes, E=connections (BFS traversal)
- Validation: O(N*P + E) where P=avg parameter size (for expression scanning)

**No performance concerns:** Both scale linearly with workflow size.

## Commits

| Commit | Type | Description |
|--------|------|-------------|
| c9a9fa1 | feat | Topology-aware layout engine with BFS positioning |
| af92680 | feat | Comprehensive validation with collect-all errors/warnings |
