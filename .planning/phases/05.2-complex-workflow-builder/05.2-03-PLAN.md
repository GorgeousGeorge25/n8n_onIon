---
phase: 05.2-complex-workflow-builder
plan: 03
type: execute
wave: 3
depends_on: ["05.2-01", "05.2-02"]
files_modified:
  - src/compiler/tests/snapshot.test.ts
  - src/compiler/tests/compiler.test.ts
  - src/compiler/tests/integration.test.ts
  - src/compiler/tests/__snapshots__
  - src/codegen/tests/typed-api.test.ts
  - src/builder/tests/workflow.test.ts
autonomous: true

must_haves:
  truths:
    - "All 5 original snapshot tests pass with updated expected values (typeVersion changes)"
    - "New snapshot tests exist for: merge with inputIndex, credentials on nodes, error connection, topology layout"
    - "Integration tests against live n8n pass for merge, credentials, and error patterns"
    - "Existing 5 typed-api tests pass without modification (no regressions)"
    - "New validation tests cover all 6 validation checks"
  artifacts:
    - path: "src/compiler/tests/snapshot.test.ts"
      provides: "Updated snapshots + new pattern tests"
      min_lines: 200
    - path: "src/compiler/tests/integration.test.ts"
      provides: "Integration tests for merge, credential, and error patterns"
      min_lines: 250
    - path: "src/compiler/tests/compiler.test.ts"
      provides: "Updated validation tests + new validation check tests"
      min_lines: 200
  key_links:
    - from: "src/compiler/tests/snapshot.test.ts"
      to: "src/compiler/compiler.ts"
      via: "compileWorkflow produces correct JSON for all patterns"
      pattern: "compileWorkflow|toMatchSnapshot"
    - from: "src/compiler/tests/integration.test.ts"
      to: "n8n API"
      via: "POST compiled workflow to n8n, verify 200/201"
      pattern: "importWorkflow|status.*20[01]"
---

<objective>
Regenerate all snapshot tests after typeVersion/layout changes, add new tests for every Phase 5.2 pattern (merge, credentials, error connections, validation), run integration tests against live n8n, and verify zero regressions in existing typed-api tests.

Purpose: Tests are the proof that all Phase 5.2 success criteria are met. Without them, we cannot verify correctness or catch regressions.

Output: All tests green. Snapshot tests updated. New tests for merge, credentials, error connections, validation, and layout. Integration tests pass against live n8n.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.2-complex-workflow-builder/05.2-01-SUMMARY.md
@.planning/phases/05.2-complex-workflow-builder/05.2-02-SUMMARY.md

@src/compiler/tests/snapshot.test.ts
@src/compiler/tests/compiler.test.ts
@src/compiler/tests/integration.test.ts
@src/codegen/tests/typed-api.test.ts
@src/builder/tests/workflow.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate snapshots and add new pattern snapshot tests</name>
  <files>
    src/compiler/tests/snapshot.test.ts
    src/compiler/tests/__snapshots__
  </files>
  <action>
**Step 1: Delete old snapshots and regenerate.**

Delete `src/compiler/tests/__snapshots__/` directory contents (the old snapshots have `typeVersion: 1` which is now wrong).

Run `npx vitest run src/compiler/tests/snapshot.test.ts --update` to regenerate all 5 existing snapshots with correct typeVersions.

Verify the regenerated snapshots have the right typeVersion values:
- Webhook: `typeVersion` should match schema's `defaultVersion` (2.1 -> use integer part or exact float)
- HTTP Request: should be 4.3 (or whichever the schema registry resolves)
- Slack: should be 2.4
- IF: should be 2.3
- Set: should be 3.4
- manualTrigger: should be 1 (has no defaultVersion, version is 1)

Note: `compileWorkflow` is now async. Update all snapshot test calls from `const result = compileWorkflow(wf)` to `const result = await compileWorkflow(wf)` and make the test callbacks `async`.

**Step 2: Add new snapshot tests for Phase 5.2 patterns.**

Add to `snapshot.test.ts`:

1. **Merge with inputIndex test:** Create a workflow with two sources (Manual Trigger -> Set 1, and a second trigger/node -> Set 2) that merge into a Merge node. Use `connect(set1, merge, 0, 0)` and `connect(set2, merge, 0, 1)` to feed into different merge inputs. Verify the compiled connections have correct `index` values (0 and 1).

2. **Credentials test:** Create a workflow with a Slack node that has credentials attached: `wf.node('Slack', 'n8n-nodes-base.slack', { resource: 'message', operation: 'post', text: 'hi' }, { slackApi: { id: '1', name: 'My Slack' } })`. Verify the compiled N8nNode has `credentials: { slackApi: { id: '1', name: 'My Slack' } }`.

3. **Error connection test:** Create a workflow with an HTTP Request node that has an error connection to an error handler Set node: `wf.connectError(httpReq, errorHandler)`. Verify the compiled output has `onError: 'continueErrorOutput'` in the HTTP Request node parameters and the error handler is connected on the appropriate output.

4. **Topology layout test:** Create a branching workflow (trigger -> IF -> true branch, false branch) and verify positions: trigger.position[0] < if.position[0] < branches.position[0], and the two branches have different Y positions.

Run `npx vitest run src/compiler/tests/snapshot.test.ts --update` to capture all new snapshots.
  </action>
  <verify>
    `npx vitest run src/compiler/tests/snapshot.test.ts` — all snapshot tests pass (9 total: 5 original + 4 new).
  </verify>
  <done>
    - 5 original snapshots regenerated with correct typeVersions
    - 4 new snapshot tests: merge inputIndex, credentials, error connection, topology layout
    - All 9 snapshot tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update compiler/validation tests and add new validation tests</name>
  <files>
    src/compiler/tests/compiler.test.ts
    src/builder/tests/workflow.test.ts
  </files>
  <action>
**Update existing compiler tests:**

1. `compileWorkflow` is now async — update all test calls to use `await` and make callbacks `async`.

2. The `validateWorkflow` tests currently check for throws. Update them to check `ValidationResult`:
   - `expect(() => validateWorkflow(...)).toThrow(...)` becomes `const result = validateWorkflow(...); expect(result.valid).toBe(false); expect(result.errors[0].code).toBe('INVALID_CONNECTION');`

**Add new validation tests to compiler.test.ts:**

3. **NO_TRIGGER test:** Workflow with only action nodes (no trigger type). Expect `errors` to contain `{ code: 'NO_TRIGGER' }`.

4. **ORPHAN_NODE test:** Workflow with 3 nodes but only 2 connected. The unconnected node should be flagged as orphan. Expect `errors` to contain `{ code: 'ORPHAN_NODE', node: 'OrphanNode' }`.

5. **INVALID_OUTPUT_INDEX test:** Connect an IF node on outputIndex 5 (IF only has 2 outputs). Expect error with `code: 'INVALID_OUTPUT_INDEX'`.

6. **MISSING_CREDENTIALS warning test:** Node with credentials attached. Expect `warnings` to contain `{ code: 'MISSING_CREDENTIALS' }` and `valid` to be `true` (warnings don't block).

7. **INVALID_REF test:** Node with parameter containing `$node['NonExistent']`. Expect error with `code: 'INVALID_REF'`.

8. **Collect-all test:** Workflow with BOTH missing trigger AND orphan node. Expect errors array to have 2+ items (proves it doesn't fail on first).

**Update builder tests:**

9. In `src/builder/tests/workflow.test.ts`, add tests for:
   - `connect()` with inputIndex parameter stores it correctly
   - `connectError()` creates connection with `connectionType: 'error'`
   - `node()` with credentials parameter stores them correctly
  </action>
  <verify>
    `npx vitest run src/compiler/tests/compiler.test.ts src/builder/tests/workflow.test.ts` — all tests pass.
  </verify>
  <done>
    - Existing compiler tests updated for async compileWorkflow and ValidationResult API
    - 6 new validation tests covering all validation check codes
    - Builder tests cover inputIndex, connectError, and credentials
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration tests and regression check</name>
  <files>
    src/compiler/tests/integration.test.ts
    src/codegen/tests/typed-api.test.ts
  </files>
  <action>
**Update existing integration tests:**

1. `compileWorkflow` is now async — update all integration test calls to use `await`.

2. Run existing 5 integration tests to verify they still pass with the new typeVersions, layout positions, etc.

**Add new integration tests:**

3. **Merge pattern integration test:** Create a workflow with Manual Trigger -> Set A, Schedule Trigger -> Set B, both merging into a Merge node using inputIndex. Compile and import to n8n. Verify 200/201 response.

4. **Error connection integration test:** Create a workflow with Manual Trigger -> HTTP Request (with connectError to an error handler Set node). Compile and import. Verify n8n accepts it.

Note: Credential integration test is skipped because we'd need real credential IDs in the n8n instance. Add a commented-out test with a TODO note for when credentials are available.

**Regression check — typed-api tests:**

5. Run `npx vitest run src/codegen/tests/typed-api.test.ts` and verify all 5 existing typed-api tests pass WITHOUT any modifications. The typed-api creates WorkflowNode objects but doesn't call the compiler, so typeVersion changes should not affect these tests. If any test fails, investigate and fix the root cause (likely a type change in WorkflowNode that broke the expected shape).

**Full test suite run:**

6. Run `npx vitest run` to execute ALL tests across the project. Verify everything passes. If any test fails, fix it before completing.
  </action>
  <verify>
    `npx vitest run` — full test suite passes (all tests green). Zero regressions.
  </verify>
  <done>
    - 5 original integration tests pass with new typeVersions
    - 2 new integration tests (merge, error connection) pass against live n8n
    - All 5 typed-api tests pass without modification (no regressions)
    - Full test suite is green
  </done>
</task>

</tasks>

<verification>
- `npx vitest run` — ALL tests pass
- Snapshot tests have correct typeVersions
- New patterns (merge, credentials, error, layout, validation) all tested
- Typed-api tests unchanged and passing (regression check)
- Integration tests pass against live n8n
</verification>

<success_criteria>
- All existing tests pass (updated for async/validation API changes)
- 4 new snapshot tests for Phase 5.2 patterns
- 6 new validation tests covering all check codes
- 3 new builder tests for inputIndex, connectError, credentials
- 2 new integration tests against live n8n
- 5 typed-api tests pass unchanged (zero regressions)
- Full `npx vitest run` is green
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-complex-workflow-builder/05.2-03-SUMMARY.md`
</output>
