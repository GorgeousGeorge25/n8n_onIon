# Phase 5.2: Complex Workflow Builder - Context

**Gathered:** 2026-01-31
**Status:** Ready for planning

<domain>
## Phase Boundary

The builder and compiler support the patterns needed for real-world complex workflows: correct typeVersions from schemas, credential references, fan-in merge connections, error-handling paths, topology-aware node layout, and richer validation. This phase fixes and extends the existing builder API — it does not add execution, testing, or new node factories.

</domain>

<decisions>
## Implementation Decisions

### Claude's Discretion

All implementation decisions deferred to Claude. The following design directions are based on the success criteria in ROADMAP.md and the existing SDK patterns:

**Credential attachment API:**
- Support referencing credentials by name (user-friendly) with lookup by ID as fallback
- Per-node attachment via the builder API (e.g., `wf.node(...).credentials(...)` or a credentials field in node params)
- Research the n8n credential API (`GET /api/v1/credentials`) first to understand the response shape and how credential types map to nodes
- Compiled JSON must include the `credentials` field so deployed workflows arrive with credentials pre-attached

**Connection API design:**
- Extend `connect()` to support `inputIndex` parameter for merge/fan-in patterns: `connect(from, to, outputIndex, inputIndex)`
- Add error connection support — either a flag on `connect()` or a separate `connectError()` method, whichever fits the existing API style better
- Compiler emits error connections separately from main connections in the n8n JSON

**Layout strategy:**
- Topology-aware: triggers on the left, linear chains flow right, branches fan out vertically, merges converge
- Replace naive grid layout with graph-structure-based positioning
- Doesn't need to be pixel-perfect — functional and readable in n8n canvas is sufficient

**Validation strictness:**
- Collect-all approach (report all issues, don't fail on first)
- Errors vs warnings: missing trigger = error, orphan nodes = error, invalid output index = error, missing credentials = warning, expression ref target missing = error
- Validation runs before compilation; errors block compilation, warnings don't

**typeVersion handling:**
- Read typeVersion from cached node schemas instead of hardcoding `1`
- Regenerate snapshot tests after this change (expected breakage)
- Test existing 5 typed factories against each compiler change to catch regressions

</decisions>

<specifics>
## Specific Ideas

No specific requirements — open to standard approaches. The success criteria in ROADMAP.md are detailed enough to guide implementation:
1. typeVersion from schemas (fixes silent correctness bug)
2. Credentials by name/ID with compiled JSON support
3. `connect()` with inputIndex for merge patterns
4. Error-handling connection type
5. Topology-aware layout
6. Richer validation (trigger exists, no orphans, valid indices, credential refs, expression refs)
7. Snapshot + integration tests for all new patterns
8. Existing 5 typed node tests pass (no regressions)

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 05.2-complex-workflow-builder*
*Context gathered: 2026-01-31*
