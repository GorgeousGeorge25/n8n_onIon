---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schema/extractor.ts
  - cli/extract.ts
  - .env.example
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running `npm run extract` successfully pulls node schemas from local n8n instance"
    - "Extractor authenticates using email/password credentials"
    - "Schema extraction works for all 5 v1 scope nodes"
  artifacts:
    - path: "src/schema/extractor.ts"
      provides: "Session-based auth and POST /rest/node-types API calls"
      min_lines: 120
      exports: ["extractNodeType", "extractNodeTypes", "listAvailableNodeTypes"]
    - path: ".env.example"
      provides: "Email/password credential examples"
      contains: "N8N_EMAIL"
  key_links:
    - from: "cli/extract.ts"
      to: "src/schema/extractor.ts"
      via: "extractNodeTypes call"
      pattern: "await extractNodeTypes"
    - from: "src/schema/extractor.ts"
      to: "POST /rest/login"
      via: "session cookie acquisition"
      pattern: "POST.*rest/login"
    - from: "src/schema/extractor.ts"
      to: "POST /rest/node-types"
      via: "schema fetch with cookie"
      pattern: "POST.*rest/node-types"
---

<objective>
Fix schema extraction to use n8n's internal API with cookie-based session authentication instead of non-existent public API endpoints.

Purpose: Enable the core schema extraction functionality that the entire SDK depends on - currently blocked by using wrong API endpoints.

Output: Working schema extractor that successfully pulls node type schemas from local n8n instance using email/password login.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/jurissleiners/MyPrograms/n8n_onIon/.planning/PROJECT.md
@/Users/jurissleiners/MyPrograms/n8n_onIon/.planning/ROADMAP.md
@/Users/jurissleiners/MyPrograms/n8n_onIon/.planning/STATE.md
@/Users/jurissleiners/MyPrograms/n8n_onIon/.planning/phases/01-foundation/01-01-SUMMARY.md
@/Users/jurissleiners/MyPrograms/n8n_onIon/.planning/phases/01-foundation/01-02-SUMMARY.md

# Files requiring modification
@/Users/jurissleiners/MyPrograms/n8n_onIon/src/schema/extractor.ts
@/Users/jurissleiners/MyPrograms/n8n_onIon/cli/extract.ts
@/Users/jurissleiners/MyPrograms/n8n_onIon/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement session-based authentication</name>
  <files>src/schema/extractor.ts, .env.example</files>
  <action>
Add session authentication to src/schema/extractor.ts:

1. Create `authenticateSession()` function:
   - POST to `${apiUrl}/rest/login` (NOT /api/v1/login)
   - Body: JSON `{email: string, password: string}`
   - Content-Type: application/json
   - Returns cookie string from Set-Cookie response header
   - Error handling for 401 (bad credentials), network errors

2. Update `extractNodeType()` function:
   - Remove X-N8N-API-KEY header approach
   - Call `authenticateSession()` once per extraction session
   - Store session cookie (simple string variable, not persistent)
   - Use POST to `${apiUrl}/rest/node-types` (NOT GET /api/v1/node-types/{nodeType})
   - Body: JSON `{nodeTypes: [nodeType]}` (array, even for single node)
   - Headers: Cookie header with session cookie
   - Response is array of node schemas - extract first element
   - Handle 404 (node type not found), 401 (session expired)

3. Update `extractNodeTypes()` function:
   - Authenticate once, reuse cookie for all node type requests
   - Can batch node types in single POST request if desired (but sequential is fine)

4. Update `listAvailableNodeTypes()` function:
   - Use POST to `${apiUrl}/rest/node-types` with empty body or no nodeTypes filter
   - Or return hardcoded list of v1 scope nodes (simpler, acceptable for v1)

5. Update .env.example:
   - Replace N8N_API_KEY with N8N_EMAIL and N8N_PASSWORD
   - Add comments explaining these are n8n login credentials
   - Keep N8N_API_URL

Why this approach:
- n8n's public REST API (/api/v1/*) does NOT expose node-types endpoint (returns 404)
- n8n's internal API (/rest/*) requires cookie-based session auth via email/password login
- This is how n8n's own frontend authenticates and fetches node schemas
- Alternative approaches (parsing npm packages, MCP server) are more complex and fragile
  </action>
  <verify>
1. Read src/schema/extractor.ts - should have authenticateSession() function
2. Read src/schema/extractor.ts - should use POST /rest/login and POST /rest/node-types
3. Read .env.example - should have N8N_EMAIL and N8N_PASSWORD instead of N8N_API_KEY
4. Run `npx tsc --noEmit` - should compile without errors
  </verify>
  <done>
- authenticateSession() function exists and implements POST /rest/login
- extractNodeType() uses session cookie with POST /rest/node-types
- .env.example documents email/password credentials
- Code compiles without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Test schema extraction against local n8n</name>
  <files>cli/extract.ts</files>
  <action>
Test the updated extractor:

1. Ensure .env file exists with valid credentials:
   - If .env missing, copy from .env.example and prompt user for credentials
   - If .env exists but has old N8N_API_KEY, update to use N8N_EMAIL/N8N_PASSWORD

2. Run extraction against local n8n instance:
   - Execute `npx tsx cli/extract.ts`
   - Should successfully authenticate and extract all 5 default node types
   - Schemas should be written to schemas/ directory

3. Verify extracted schemas:
   - Check that schemas/*.json files exist (5 files)
   - Spot-check one schema (e.g., n8n-nodes-base.slack.json) has properties array with displayOptions

4. Run type generation to confirm pipeline works end-to-end:
   - Execute `npx tsx cli/generate.ts`
   - Should generate types from newly extracted schemas
   - Run `npx tsc --noEmit` to verify generated types compile

If authentication fails with "invalid credentials" error:
- This is expected if user hasn't configured .env yet
- Create checkpoint explaining user needs to set N8N_EMAIL and N8N_PASSWORD in .env
- DO NOT FAIL - this is user configuration, not code failure

If POST /rest/node-types returns different structure than expected:
- Log the actual response structure
- Adjust type extraction logic accordingly
- This is acceptable discovery during implementation
  </action>
  <verify>
1. Run `npx tsx cli/extract.ts` - should complete without errors (assuming valid credentials)
2. Run `ls schemas/*.json | wc -l` - should show 5 files
3. Run `cat schemas/n8n-nodes-base.slack.json | grep -q displayOptions` - should find displayOptions
4. Run `npx tsx cli/generate.ts` - should regenerate types
5. Run `npx tsc --noEmit` - should compile successfully
  </verify>
  <done>
- Schema extraction completes successfully with session auth
- All 5 v1 scope node schemas cached as JSON files
- Schemas contain properties with displayOptions (validated structure)
- Generated types compile without errors
- End-to-end pipeline (extract → generate → compile) works
  </done>
</task>

</tasks>

<verification>
## Overall Success Criteria

1. `npm run extract` pulls node schemas from local n8n using email/password auth
2. POST /rest/login successfully acquires session cookie
3. POST /rest/node-types returns node type schemas using session cookie
4. All 5 v1 scope nodes extract successfully
5. Generated types compile without errors
6. End-to-end pipeline (extract → cache → generate → compile) works

## UAT Gap Resolution

This plan addresses the blocker gap from 01-UAT.md:
- **Gap truth:** "Running `npm run extract` pulls node schemas from local n8n and saves them as JSON"
- **Root cause:** Using non-existent /api/v1/node-types endpoint
- **Fix:** Switch to POST /rest/node-types with cookie-based session auth
</verification>

<success_criteria>
1. Extractor authenticates using email/password credentials (not API key)
2. Schema extraction uses POST /rest/node-types (not GET /api/v1/node-types)
3. Running `npm run extract` successfully pulls all 5 node schemas
4. Schemas saved to schemas/ directory with correct structure
5. Type generation and compilation work with newly extracted schemas
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` following the standard summary template.

Include:
- What was learned about n8n's internal API structure
- Actual request/response format for POST /rest/login and POST /rest/node-types
- Any differences from expected schema structure
- Performance notes (extraction time for 5 nodes)
</output>
