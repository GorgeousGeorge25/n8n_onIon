---
phase: 04-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compiler/tests/snapshots/webhook.test.ts
  - src/compiler/tests/snapshots/httpRequest.test.ts
  - src/compiler/tests/snapshots/slack.test.ts
  - src/compiler/tests/snapshots/if.test.ts
  - src/compiler/tests/snapshots/set.test.ts
  - src/compiler/tests/snapshot.test.ts
autonomous: true

must_haves:
  truths:
    - "Webhook trigger node compiles with httpMethod, path, and responseMode parameters"
    - "HTTP Request node compiles with method, url, and authentication parameters"
    - "Slack node compiles with resource/operation branching (message.post parameters)"
    - "IF node compiles with conditions and produces two output branches (true/false)"
    - "Set node compiles with field assignments (keepOnlySet, values)"
    - "All 5 snapshot tests pass comparing compiled output to expected n8n JSON structure"
  artifacts:
    - path: "src/compiler/tests/snapshot.test.ts"
      provides: "Snapshot tests for all 5 target nodes"
      min_lines: 100
  key_links:
    - from: "src/compiler/tests/snapshot.test.ts"
      to: "src/builder/workflow.ts"
      via: "workflow(), trigger(), node(), connect() calls"
      pattern: "workflow\\("
    - from: "src/compiler/tests/snapshot.test.ts"
      to: "src/compiler/compiler.ts"
      via: "compileWorkflow() call"
      pattern: "compileWorkflow"
---

<objective>
Create snapshot tests that build example workflows for all 5 target nodes (Webhook, HTTP Request, Slack, IF, Set) using the SDK builder API, compile them, and verify the compiled n8n JSON matches the expected structure.

Purpose: Proves each node type compiles correctly with its specific parameters, covering NODE-01 through NODE-05 and TEST-01 requirements.
Output: One test file with snapshot tests for all 5 nodes, each verifying the compiled JSON structure matches known-good n8n output.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/builder/workflow.ts
@src/builder/types.ts
@src/compiler/compiler.ts
@src/compiler/types.ts
@src/expressions/reference.ts
@src/expressions/template.ts
@src/compiler/tests/compiler.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create snapshot tests for all 5 target nodes</name>
  <files>src/compiler/tests/snapshot.test.ts</files>
  <action>
Create a single test file `src/compiler/tests/snapshot.test.ts` with vitest snapshot tests for each of the 5 target nodes. Each test builds a realistic workflow using the SDK builder API, compiles it with `compileWorkflow()`, then uses `toMatchSnapshot()` on the compiled JSON (with UUIDs replaced by deterministic values to avoid snapshot churn).

**UUID normalization:** Before snapshotting, replace all UUID fields in compiled output with deterministic placeholders (e.g., `node.id = 'uuid-0'`, `'uuid-1'`, etc.) so snapshots are stable across runs.

**For each node, use these EXACT configurations:**

1. **Webhook (NODE-01):** `n8n-nodes-base.webhook`
   - Parameters: `{ httpMethod: 'POST', path: 'test-webhook', responseMode: 'onReceived' }`
   - This is a trigger node (use `wf.trigger()`)
   - Connect to a simple Set node as downstream

2. **HTTP Request (NODE-02):** `n8n-nodes-base.httpRequest`
   - Parameters: `{ method: 'GET', url: 'https://api.example.com/users', authentication: 'none', options: {} }`
   - Connect from a manual trigger

3. **Slack (NODE-03):** `n8n-nodes-base.slack`
   - Parameters: `{ resource: 'message', operation: 'post', channel: '#general', text: 'Hello from n8n' }`
   - Use expression for text: use `ref('Webhook').out.body.message` via the expression system, calling `.toString()` to get the `={{ ... }}` format
   - Connect from a Webhook trigger

4. **IF (NODE-04):** `n8n-nodes-base.if`
   - Parameters: `{ conditions: { string: [{ value1: '={{ $json.status }}', operation: 'equal', value2: 'active' }] } }`
   - Connect from a trigger, connect output 0 (true) to one node, output 1 (false) to another node
   - This tests the branching connection format with two outputs

5. **Set (NODE-05):** `n8n-nodes-base.set`
   - Parameters: `{ keepOnlySet: true, values: { string: [{ name: 'fullName', value: '={{ $json.firstName + " " + $json.lastName }}' }] } }`
   - Connect from a trigger

**Test structure for each:**
```typescript
it('should compile [NodeName] workflow', () => {
  const wf = workflow('[Test Name]');
  // ... build workflow ...
  const result = compileWorkflow(wf);
  const normalized = normalizeUUIDs(result);
  expect(normalized).toMatchSnapshot();
});
```

Also add individual structural assertions for each node (not just snapshot):
- Webhook: verify `httpMethod`, `path`, `responseMode` are in parameters
- HTTP Request: verify `method`, `url`, `authentication` are in parameters
- Slack: verify `resource`, `operation`, `channel` are in parameters, text contains expression
- IF: verify connections have TWO output branches (main[0] and main[1])
- Set: verify `keepOnlySet`, `values.string` structure

Import `workflow` from `../../builder/workflow.js`, `compileWorkflow` from `../compiler.js`, `ref` from `../../expressions/reference.js`.
  </action>
  <verify>Run `npx vitest run src/compiler/tests/snapshot.test.ts` — all 5 tests pass. First run creates snapshot files; subsequent runs validate against them.</verify>
  <done>5 snapshot tests pass, each verifying a different target node compiles correctly with expected parameters and connection structure. Snapshot files created in __snapshots__ directory.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify no regressions</name>
  <files>N/A (verification only)</files>
  <action>
Run the complete test suite with `npx vitest run` to confirm:
1. All 5 new snapshot tests pass
2. All existing compiler tests still pass
3. All existing expression tests still pass
4. All existing workflow builder tests still pass

If any test fails, fix the issue. The most likely issue is import paths — ensure all use `.js` extensions for ESM compatibility.
  </action>
  <verify>Run `npx vitest run` — all tests pass (0 failures).</verify>
  <done>Full test suite passes with 0 failures. New snapshot tests integrated without regressions.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/compiler/tests/snapshot.test.ts` — 5 snapshot tests pass
2. `npx vitest run` — full test suite passes with 0 failures
3. Snapshot files exist in `src/compiler/tests/__snapshots__/`
4. Each snapshot contains correct n8n JSON structure (nodes array, connections object, active: false, settings)
</verification>

<success_criteria>
- All 5 target nodes have snapshot tests that verify compiled output
- Each node test exercises the specific parameters listed in phase success criteria
- IF node test verifies branching connections (two output branches)
- Slack node test uses expression system for dynamic text
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-01-SUMMARY.md`
</output>
