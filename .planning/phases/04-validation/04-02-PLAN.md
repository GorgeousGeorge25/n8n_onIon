---
phase: 04-validation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/compiler/tests/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Compiled webhook workflow imports into n8n via REST API without errors"
    - "Compiled HTTP Request workflow imports into n8n via REST API without errors"
    - "Compiled Slack workflow imports into n8n via REST API without errors"
    - "Compiled IF workflow imports into n8n via REST API without errors"
    - "Compiled Set workflow imports into n8n via REST API without errors"
    - "Integration tests clean up created workflows after each test"
  artifacts:
    - path: "src/compiler/tests/integration.test.ts"
      provides: "Integration tests importing compiled workflows into n8n"
      min_lines: 80
  key_links:
    - from: "src/compiler/tests/integration.test.ts"
      to: "src/compiler/compiler.ts"
      via: "compileWorkflow() to generate JSON"
      pattern: "compileWorkflow"
    - from: "src/compiler/tests/integration.test.ts"
      to: "n8n REST API"
      via: "fetch POST /api/v1/workflows"
      pattern: "fetch.*workflows"
---

<objective>
Create integration tests that compile workflows for all 5 target nodes and import them into a running n8n instance via REST API, verifying they import without errors.

Purpose: Proves compiled SDK output is accepted by actual n8n, satisfying TEST-02 requirement and the core project value of "import and execute correctly on first try."
Output: Integration test file that compiles and imports 5 workflows into n8n, with cleanup.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation/04-01-SUMMARY.md

@src/builder/workflow.ts
@src/compiler/compiler.ts
@src/compiler/types.ts
@src/expressions/reference.ts
@cli/extract.ts
@.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration tests that import compiled workflows into n8n</name>
  <files>src/compiler/tests/integration.test.ts</files>
  <action>
Create `src/compiler/tests/integration.test.ts` that:

1. **Authentication:** Follow the same pattern as `cli/extract.ts` — use session-based auth by POSTing to `/rest/login` with email/password from environment, then use the session cookie for subsequent requests. Load env vars from `.env` using dotenv.

2. **n8n API helper:** Create a small helper within the test file:
   - `login()` — POST `/rest/login` with `{ email, password }`, store cookie
   - `importWorkflow(json)` — POST `/api/v1/workflows` with workflow JSON body, return response with workflow ID
   - `deleteWorkflow(id)` — DELETE `/api/v1/workflows/{id}` to clean up

3. **Test structure:** Use `describe.sequential` (vitest) to run tests in order. Use `beforeAll` to login once. Use `afterAll` or `afterEach` to delete created workflows (track IDs in an array).

4. **Skip condition:** If n8n is not running (login fails), skip all tests gracefully with a console warning: "Skipping integration tests: n8n not available at {url}". Do NOT fail the test suite if n8n is down.

5. **5 integration tests** — one per node type. Each test:
   - Builds a workflow using the SDK (same configurations as Plan 01 snapshot tests)
   - Compiles with `compileWorkflow()`
   - POSTs to n8n API to import
   - Asserts response status is 200 (or 201)
   - Asserts response body contains `id` field (workflow was created)
   - Stores workflow ID for cleanup

**n8n API details (from extract.ts pattern):**
- Base URL: `process.env.N8N_API_URL` (default: `http://localhost:5678`)
- Login: `POST /rest/login` with `{ email: process.env.N8N_EMAIL, password: process.env.N8N_PASSWORD }`
- Cookie from login response: extract `Set-Cookie` header
- Import workflow: `POST /api/v1/workflows` with JSON body, include cookie header
- Delete workflow: `DELETE /api/v1/workflows/{id}`, include cookie header

**Important:** Use `describe.skipIf` or manual skip logic so integration tests don't block the test suite when n8n is unavailable. The typical pattern:

```typescript
let available = false;
beforeAll(async () => {
  try { await login(); available = true; }
  catch { console.warn('n8n not available, skipping integration tests'); }
});

it.skipIf(!available)('should import webhook workflow', async () => { ... });
```

Actually, since vitest needs the skip condition to be known at describe time, use a different pattern:
- Try to connect in a setup file or use `describe.runIf(condition)`
- Or: wrap all tests in try/catch with early return and `it.skip`

Simplest approach: Use `describe` block, `beforeAll` logs in, if login fails set a flag, each test checks the flag at start and calls `return` (effectively skipping).
  </action>
  <verify>
If n8n is running: `npx vitest run src/compiler/tests/integration.test.ts` — 5 tests pass, workflows imported and cleaned up.
If n8n is NOT running: tests skip gracefully, full suite still passes.
  </verify>
  <done>5 integration tests verify compiled workflows import into n8n without errors. Tests clean up after themselves. Tests skip gracefully when n8n is unavailable.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify complete phase success</name>
  <files>N/A (verification only)</files>
  <action>
Run the complete test suite:
1. `npx vitest run` — all tests pass (snapshot + integration + existing)
2. Verify integration tests either pass (n8n running) or skip gracefully (n8n not running)
3. Confirm total test count: existing tests + 5 snapshot tests + 5 integration tests

If any test fails, debug and fix. Common issues:
- n8n API returns different status codes than expected (check 200 vs 201)
- Cookie header format issues
- Workflow JSON missing required fields that n8n expects (may need to add `pinData: {}` or `staticData: null`)
  </action>
  <verify>`npx vitest run` — all tests pass (0 failures). Integration tests either pass or skip cleanly.</verify>
  <done>Full test suite passes. Phase 4 requirements (TEST-01, TEST-02, NODE-01 through NODE-05) all satisfied.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/compiler/tests/integration.test.ts` — integration tests pass or skip gracefully
2. `npx vitest run` — full test suite passes with 0 failures
3. n8n workflow list (if n8n running) shows no leftover test workflows (cleanup worked)
</verification>

<success_criteria>
- Integration tests import compiled workflows for all 5 nodes into n8n via API
- Each import returns success (200/201) with workflow ID
- Test cleanup removes all created workflows
- Tests skip gracefully when n8n is unavailable
- Full test suite passes with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-02-SUMMARY.md`
</output>
