---
phase: 05-typed-node-api
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/codegen/conditional.ts
  - src/codegen/generator.ts
  - generated/nodes.ts
  - src/codegen/typed-api.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "generated/nodes.ts compiles without TS2300 duplicate identifier errors"
    - "typed-api.ts imports param types from generated/nodes.ts instead of defining inline copies"
    - "All 61+ existing tests continue to pass"
  artifacts:
    - path: "src/codegen/conditional.ts"
      provides: "Property deduplication in buildDiscriminatedUnions"
      contains: "deduplicate|seen|Map"
    - path: "generated/nodes.ts"
      provides: "Clean generated types with no duplicate properties and no double export keyword"
    - path: "src/codegen/typed-api.ts"
      provides: "Imports param types from generated/nodes.ts"
      contains: "from '../../generated/nodes.js'"
  key_links:
    - from: "src/codegen/typed-api.ts"
      to: "generated/nodes.ts"
      via: "import type { SlackMessagePost, HttpRequestNode, ... }"
      pattern: "import.*from.*generated"
---

<objective>
Fix codegen to eliminate duplicate properties in generated/nodes.ts, then rewire typed-api.ts to import generated types instead of maintaining inline copies.

Purpose: Closes the last verification gap — "Generated types are consumed by the typed API" (currently partial because typed-api.ts uses inline types as a workaround for TS2300 errors in generated/nodes.ts).

Output: generated/nodes.ts that compiles cleanly, typed-api.ts that imports from it.
</objective>

<execution_context>
@/Users/jurissleiners/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jurissleiners/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-typed-node-api/05-VERIFICATION.md
@src/codegen/conditional.ts
@src/codegen/generator.ts
@src/codegen/typed-api.ts
@generated/nodes.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix codegen to deduplicate properties and fix double-export bug</name>
  <files>src/codegen/conditional.ts, src/codegen/generator.ts, generated/nodes.ts</files>
  <action>
Fix two codegen bugs in `src/codegen/conditional.ts`:

**Bug 1: Duplicate properties per interface.** In `buildDiscriminatedUnions()`, the loop at lines 130-138 collects properties from `tree.commonProperties` and then branch-specific `properties`. When n8n's displayOptions makes the same property appear under multiple conditions (e.g., `body?` for both `json` and `raw` contentType), duplicates are emitted.

Fix: After collecting all properties for an interface (common + branch), deduplicate by property name. When a property name appears more than once with different types, merge them into a union type. Use a `Map<string, string[]>` keyed by property name, collecting type strings. After iterating, emit each property once. If multiple type strings exist for the same name, join with ` | ` and wrap in parentheses if needed.

Specifically, replace the field-building section (approximately lines 124-138) in `buildDiscriminatedUnions()`:

```typescript
// Collect all props (common + branch), dedup by name
const allProps = [...tree.commonProperties, ...properties];
const seen = new Map<string, { optional: boolean; types: Set<string> }>();

for (const prop of allProps) {
  const existing = seen.get(prop.name);
  const tsLine = generatePropertyType(prop);
  // Extract type from "  name?: type;" pattern
  const typeMatch = tsLine.match(/:\s*(.+);$/);
  const tsType = typeMatch ? typeMatch[1] : 'unknown';
  const isOptional = !prop.required;

  if (existing) {
    existing.types.add(tsType);
    // Property is optional if ANY occurrence is optional
    if (isOptional) existing.optional = true;
  } else {
    seen.set(prop.name, { optional: isOptional, types: new Set([tsType]) });
  }
}

for (const [name, info] of seen.entries()) {
  const opt = info.optional ? '?' : '';
  const mergedType = [...info.types].join(' | ');
  fields.push(`  ${name}${opt}: ${mergedType};`);
}
```

**Bug 2: Double `export` keyword.** In `buildDiscriminatedUnions()` line 140, the template emits `export interface`. But `generateNodeType()` in `generator.ts` line 43 also calls `buildDiscriminatedUnions()` whose output is included directly. The issue is that `buildDiscriminatedUnions()` already produces `export interface` but somewhere a second `export` is prepended. Check `generator.ts` — if `generateNodeType()` prepends `export` before calling `buildDiscriminatedUnions()`, remove the extra one. The fix may just be in `conditional.ts` line 140 — verify the template literal does NOT have double `export`. If the bug is that `generateNodeType()` wraps the result with another `export`, fix it there.

After fixing the code, regenerate `generated/nodes.ts` by running:
```bash
npx tsx scripts/generate.ts
```
Or if no generate script exists, run whatever command produces `generated/nodes.ts` (check `package.json` scripts for `generate`).

After regeneration, verify:
- `npx tsc --noEmit` passes on `generated/nodes.ts` (no TS2300 errors)
- No `export export` appears in generated output
- No duplicate property names within any single interface
  </action>
  <verify>
Run:
```bash
npx tsc --noEmit
grep -c 'export export' generated/nodes.ts  # Should be 0
```
Also manually scan a few interfaces in generated/nodes.ts (HttpRequestNode, SlackMessagePost, SetNode) to confirm no duplicate property names.
  </verify>
  <done>
generated/nodes.ts compiles cleanly with `tsc --noEmit`, has zero `export export` occurrences, and no interface contains duplicate property names. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire typed-api.ts to import from generated/nodes.ts</name>
  <files>src/codegen/typed-api.ts</files>
  <action>
Replace the 14 inline param interfaces in `src/codegen/typed-api.ts` with imports from `generated/nodes.ts`.

**Step 1:** Add import statement at top of file (after the existing WorkflowNode import):

```typescript
import type {
  WebhookNode,
  HttpRequestNode,
  IfNode,
  SetNode,
  SlackMessagePost,
  SlackMessageUpdate,
  SlackMessageDelete,
  SlackMessageSearch,
  SlackMessageGetpermalink,
  SlackChannelCreate,
  SlackChannelArchive,
  SlackChannelGet,
  SlackChannelGetall,
  Expression,
  ResourceLocator,
} from '../../generated/nodes.js';
```

**Step 2:** Remove the inline interface definitions for `Expression`, `ResourceLocator`, `WebhookParams`, `HttpRequestParams`, `IfParams`, `SetParams`, and all `Slack*Params` interfaces (lines ~17-156 approximately).

**Step 3:** Create type aliases that strip the `resource`/`operation` discriminant fields from Slack types (since the factory auto-injects them). Use `Omit`:

```typescript
// Strip resource/operation — factory auto-injects these discriminants
type SlackMessagePostParams = Omit<SlackMessagePost, 'resource' | 'operation'>;
type SlackMessageUpdateParams = Omit<SlackMessageUpdate, 'resource' | 'operation'>;
type SlackMessageDeleteParams = Omit<SlackMessageDelete, 'resource' | 'operation'>;
type SlackMessageSearchParams = Omit<SlackMessageSearch, 'resource' | 'operation'>;
type SlackMessageGetPermalinkParams = Omit<SlackMessageGetpermalink, 'resource' | 'operation'>;
type SlackChannelCreateParams = Omit<SlackChannelCreate, 'resource' | 'operation'>;
type SlackChannelArchiveParams = Omit<SlackChannelArchive, 'resource' | 'operation'>;
type SlackChannelGetParams = Omit<SlackChannelGet, 'resource' | 'operation'>;
type SlackChannelGetAllParams = Omit<SlackChannelGetall, 'resource' | 'operation'>;
```

**Step 4:** For simple nodes (Webhook, HttpRequest, If, Set), alias directly since they have no discriminant fields:

```typescript
type WebhookParams = WebhookNode;
type HttpRequestParams = HttpRequestNode;
type IfParams = IfNode;
type SetParams = SetNode;
```

**Step 5:** Update the `TypedNodes` interface and factory to use these type aliases. The method signatures stay the same — they already reference `WebhookParams`, `HttpRequestParams`, etc.

**Step 6:** Remove the `[key: string]: unknown` index signatures that were on the old inline types (like HttpRequestParams, SetParams, SlackMessagePostParams, SlackMessageUpdateParams). The generated types don't have these, so the factory's `as unknown as Record<string, unknown>` casts handle the conversion.

**Step 7:** Ensure the TypedNodes interface and createTypedNodes factory still compile and the existing 9 typed-api tests pass.

IMPORTANT: The generated types use `Expression<T>` and `ResourceLocator` from the generated file, not from inline definitions. Make sure the import includes these shared types and they are NOT redefined in typed-api.ts.

IMPORTANT: Keep the `TypedNodes` interface and `createTypedNodes()` function exported — they are re-exported from `src/index.ts`.
  </action>
  <verify>
Run:
```bash
npx vitest run
npx tsc --noEmit
```
All 61+ tests pass. TypeScript compilation succeeds. The typed-api.ts file imports from generated/nodes.ts (verify with `grep "generated/nodes" src/codegen/typed-api.ts`).
  </verify>
  <done>
typed-api.ts imports all param types from generated/nodes.ts. Zero inline interface definitions remain (only type aliases using Omit). All tests pass. The key link typed-api.ts → generated/nodes.ts is now wired.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `npx tsc --noEmit` — full project compiles without errors
2. `npx vitest run` — all 61+ tests pass (no regressions)
3. `grep "generated/nodes" src/codegen/typed-api.ts` — import exists
4. `grep -c 'export export' generated/nodes.ts` — returns 0
5. No duplicate property names in generated/nodes.ts interfaces

These verify all three gap items:
- Codegen produces valid TS (no duplicate properties)
- typed-api.ts consumes generated types (import wired)
- Double export bug fixed
</verification>

<success_criteria>
- generated/nodes.ts compiles cleanly with `tsc --noEmit`
- typed-api.ts imports param types from generated/nodes.ts (no inline copies)
- All existing tests pass (61+ tests, 0 failures)
- The verification gap "Generated types consumed by typed API" is fully closed
</success_criteria>

<output>
After completion, create `.planning/phases/05-typed-node-api/05-03-SUMMARY.md`
</output>
