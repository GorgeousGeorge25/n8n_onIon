---
phase: 05.3-automated-workflow-testing
plan: 02
subsystem: testing
tags: [testing, n8n-api, webhook, assertions, test-harness]

# Dependency graph
requires:
  - phase: 05.3-01
    provides: Executor module with getExecution, pollExecution, triggerWebhook, deleteWorkflow, extractNodeData
provides:
  - testWorkflow() function for end-to-end workflow testing
  - Test scenario types for defining input/output expectations
  - Test report types with detailed failure diagnostics
  - Automated deploy/execute/assert/cleanup loop
affects: [05.3-03, testing-infrastructure, workflow-validation]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Scenario-based testing: define expected inputs/outputs, get pass/fail results"
    - "Test harness pattern: deploy → execute → assert → cleanup in one function"
    - "Detailed failure reporting: type, message, expected, actual for debugging"

key-files:
  created:
    - src/executor/test-harness.ts
  modified:
    - src/executor/types.ts

key-decisions:
  - "2-second delay after activation for webhook registration (n8n needs time to load workflow)"
  - "Extract webhook path from builder or accept explicit option (flexibility for different test scenarios)"
  - "Deep comparison using JSON.stringify for object assertions (simple, reliable)"
  - "Always cleanup workflow even on test failure (prevent n8n clutter)"
  - "Return detailed failures with type/message/expected/actual (enable Claude to diagnose and fix)"

patterns-established:
  - "Test scenario structure: name, triggerData, expectedStatus, expectedNodes, expectedOutput"
  - "Test report aggregation: passed/failed counts, per-scenario results, cleanup status"
  - "Nested field access via dot notation (e.g., 'user.id') for output assertions"

# Metrics
duration: 2min
completed: 2026-02-01
---

# Phase 05.3 Plan 02: Test Harness Summary

**testWorkflow() function provides end-to-end workflow testing with scenario-based assertions, detailed failure diagnostics, and automatic cleanup**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-01T02:37:28Z
- **Completed:** 2026-02-01T02:39:07Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- testWorkflow() function deploys, executes, asserts, and cleans up workflows in single call
- Scenario-based testing with input payloads paired with expected outcomes
- Detailed failure reporting with type, message, expected, and actual values for Claude diagnostics
- Automatic webhook path extraction from builder or explicit configuration
- Always cleans up workflow even on test failure

## Task Commits

Each task was committed atomically:

1. **Task 1: Add test scenario and result types** - `7031f84` (feat)
2. **Task 2: Build testWorkflow function** - `3adfded` (feat)

## Files Created/Modified
- `src/executor/types.ts` - Added TestScenario, TestResult, TestReport, TestFailure, OutputAssertion types
- `src/executor/test-harness.ts` - Created testWorkflow function with deploy/execute/assert/cleanup loop

## Decisions Made

**2-second delay after activation for webhook registration**
- Rationale: n8n needs time to load and register webhooks after activation. Without delay, webhook triggers may fail with 404.

**Extract webhook path from builder or accept explicit option**
- Rationale: Flexibility for different test scenarios. Auto-extraction works for standard workflows, explicit path for advanced cases.

**Deep comparison using JSON.stringify for object assertions**
- Rationale: Simple, reliable comparison for complex objects. Avoids deep-equality library dependency.

**Always cleanup workflow even on test failure**
- Rationale: Prevents n8n instance clutter with test workflows. Uses try/finally to guarantee cleanup.

**Return detailed failures with type/message/expected/actual**
- Rationale: Enables Claude to diagnose and fix failures. Includes actual output data for debugging.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation was straightforward based on existing executor module from 05.3-01.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for 05.3-03 (Feedback Loop):**
- testWorkflow() provides the foundation for self-diagnosis and fix workflow
- Detailed failure diagnostics enable Claude to understand what went wrong
- Test harness integrated with deployer and executor modules

**Key capabilities for next phase:**
- Execute workflows with sample data
- Get pass/fail results with detailed diagnostics
- Automatically cleanup after testing
- Support multiple test scenarios per workflow

---
*Phase: 05.3-automated-workflow-testing*
*Completed: 2026-02-01*
