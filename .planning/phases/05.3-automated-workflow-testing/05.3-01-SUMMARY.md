---
phase: 05.3-automated-workflow-testing
plan: 01
subsystem: executor
tags: [n8n-api, execution, polling, webhook, testing-infrastructure]
dependency-graph:
  requires: [05.1-deployable-package, 05.2-complex-workflow-builder]
  provides: [execution-api, execution-polling, webhook-trigger, workflow-cleanup]
  affects: [05.3-02-test-harness, 05.3-03-feedback-loop]
tech-stack:
  added: []
  patterns: [env-var-fallback, polling-with-timeout, execution-data-parsing]
decisions:
  - slug: webhook-over-manual-trigger
    title: Use webhook-based execution instead of Manual Trigger
    rationale: n8n public API v1 does not support programmatic execution of Manual Trigger workflows
    alternatives: [internal-api-with-cookies, schedule-trigger-polling]
    outcome: Webhook execution is the only viable option for automated testing
  - slug: include-data-parameter
    title: Use ?includeData=true for full execution results
    rationale: Default GET /api/v1/executions/{id} response omits node output data
    alternatives: [separate-endpoint-for-data, assume-data-always-included]
    outcome: Query parameter successfully retrieves full execution data
  - slug: flatten-execution-data
    title: Provide extractNodeData() helper for test assertions
    rationale: n8n's nested execution data structure (runData > runs > data > main > branches > items) is complex
    alternatives: [raw-execution-data-only, custom-assertion-library]
    outcome: Simple helper flattens to {nodeName, data[]} for easier testing
key-files:
  created:
    - src/executor/types.ts
    - src/executor/execute.ts
  modified: []
metrics:
  duration: 6
  completed: 2026-02-01
---

# Phase 05.3 Plan 01: Research and Build Executor Module Summary

**One-liner:** Executor module with webhook triggering, execution polling, and data extraction based on verified n8n API v2.2.4 patterns

## What Was Built

### Executor Module (`src/executor/`)

**src/executor/types.ts** — Execution data types based on actual n8n API responses:
- `ExecutionStatus` — Status enum: new, running, success, error, waiting, canceled
- `ExecutionResult` — Parsed execution with id, status, mode, timestamps, node data
- `ExecutionData` — Full n8n execution data structure (version, startData, resultData)
- `NodeRunData` — Single node execution run with startTime, executionTime, output data
- `ExecutionError` — Error details with message, node, stack trace
- `ExecutionOptions` — Config options: apiUrl, apiKey, pollIntervalMs, timeoutMs
- `NodeExecutionData` — Simplified node data for test assertions

**src/executor/execute.ts** — Core execution functions:

1. **`getExecution(executionId, options)`** — Fetch execution by ID with full node outputs
   - Calls `GET /api/v1/executions/{id}?includeData=true`
   - Parses n8n response into ExecutionResult
   - Throws descriptive errors on failure

2. **`pollExecution(executionId, options)`** — Poll until completion or timeout
   - Polls getExecution() every pollIntervalMs (default 500ms)
   - Returns when status is finished
   - Throws timeout error after timeoutMs (default 30000ms)

3. **`triggerWebhook(path, payload, options)`** — POST to webhook endpoint
   - Calls `POST /webhook/{path}` with JSON payload
   - Returns response data (JSON or text)
   - Only works for active workflows with registered webhooks

4. **`deleteWorkflow(workflowId, options)`** — Delete workflow for cleanup
   - Calls `DELETE /api/v1/workflows/{id}`
   - Throws descriptive errors on failure

5. **`extractNodeData(execution)`** — Flatten execution data for tests
   - Extracts `{nodeName, data[]}` from complex n8n structure
   - Simplifies test assertions

All functions use env var fallback pattern: `options > process.env > defaults`

## Research Findings (Task 1)

Tested n8n public API v1 endpoints on live instance at http://localhost:5678 (n8n v2.2.4):

### Manual Trigger Execution — NOT SUPPORTED
Tested endpoints:
- `POST /api/v1/workflows/{id}/execute` → 405 Method Not Allowed
- `POST /api/v1/workflows/{id}/run` → 405 Method Not Allowed
- `POST /api/v1/executions` → 405 Method Not Allowed
- `POST /rest/workflows/{id}/run` → 401 Unauthorized (internal API, requires cookie auth)

**Finding:** n8n public API v1 **does not support** programmatic execution of Manual Trigger workflows.

### Webhook Trigger — SUPPORTED (with caveats)
- `POST /webhook/{path}` → Works after workflow activation + webhook registration
- `POST /webhook-test/{path}` → Works only in test mode (requires manual "Execute workflow" click)

**Limitation:** Webhooks require registration (activation + n8n loading workflow). Not reliable for automated testing without workflow activation.

### Get Execution — SUPPORTED ✓
- `GET /api/v1/executions/{id}` → Returns execution summary (no node data)
- `GET /api/v1/executions/{id}?includeData=true` → Returns full execution with per-node output data

**Response shape (verified):**
```json
{
  "id": "664",
  "finished": true,
  "status": "success",
  "mode": "integrated",
  "workflowId": "RSdafbHcPygOrQl6",
  "startedAt": "2026-01-31T16:00:45.059Z",
  "stoppedAt": "2026-01-31T16:00:45.067Z",
  "data": {
    "version": 1,
    "startData": {},
    "resultData": {
      "runData": {
        "Node Name": [{
          "startTime": 1769875245063,
          "executionTime": 4,
          "data": {
            "main": [
              [{ "json": { "key": "value" } }]
            ]
          }
        }]
      }
    }
  }
}
```

### List Executions — SUPPORTED ✓
- `GET /api/v1/executions?limit=5` → Returns array of execution summaries

### Delete Workflow — SUPPORTED ✓
- `DELETE /api/v1/workflows/{id}` → Returns deleted workflow object

## Deviations from Plan

### Auto-adapted Implementation (Rule 2 - Missing Critical)

**1. Webhook-based execution instead of Manual Trigger**

- **Found during:** Task 1 research
- **Issue:** Plan assumed Manual Trigger workflows could be executed via API. Research proved this is impossible with n8n public API v1.
- **Fix:** Built executor with webhook support (triggerWebhook function) as primary execution method. Polling (pollExecution, getExecution) still works for any execution type.
- **Files modified:** src/executor/execute.ts (added triggerWebhook instead of executeWorkflow for Manual Trigger)
- **Rationale:** Webhook-based execution is the only viable option for automated workflow testing via public API. Manual Trigger execution requires internal API with cookie authentication (complex, brittle, not recommended).

**2. Added extractNodeData() helper**

- **Found during:** Task 2 implementation
- **Issue:** n8n's execution data structure is deeply nested (runData > runs > data > main > branches > items). Writing test assertions directly against this structure would be verbose and brittle.
- **Fix:** Added extractNodeData() helper that flattens execution data to simple {nodeName, data[]} format
- **Files modified:** src/executor/execute.ts
- **Rationale:** Simplifies test assertions and hides n8n's complex internal structure. Tests can assert `nodeData.find(n => n.nodeName === 'Set').data[0].message` instead of `execution.data.resultData.runData['Set'][0].data.main[0][0].json.message`.

**3. Added ?includeData=true parameter**

- **Found during:** Task 1 research
- **Issue:** Default GET /api/v1/executions/{id} response omits node output data
- **Fix:** All getExecution calls include `?includeData=true` query parameter
- **Files modified:** src/executor/execute.ts
- **Rationale:** Without this parameter, execution results only contain metadata (status, timestamps) but no actual node outputs. Including it retrieves the full data needed for test verification.

None of these deviations required user permission (Rule 2 - critical for operation, Rule 3 - blocking). They are necessary adaptations to the actual n8n API capabilities discovered during research.

## Implementation Notes

### Env Var Fallback Pattern (consistent with deployer)

All functions follow: `options > process.env > defaults`

```typescript
const apiUrl = options?.apiUrl || process.env.N8N_API_URL || 'http://localhost:5678';
const apiKey = options?.apiKey || process.env.N8N_API_KEY || '';
```

### Error Handling

- Descriptive errors with context (execution ID, status, message)
- Timeout errors include execution ID for debugging
- API errors include response status and message

### Polling Strategy

- Default poll interval: 500ms (configurable)
- Default timeout: 30s (configurable)
- Stops when execution.finished === true
- Throws timeout error with current status for debugging

## Verification Results

✓ `npx tsc --noEmit` — No type errors
✓ `npx vitest run` — All 80 existing tests pass
✓ Types match actual n8n API v2.2.4 response shapes (verified via live instance)
✓ Functions use correct endpoints: GET /api/v1/executions/{id}?includeData=true, DELETE /api/v1/workflows/{id}, POST /webhook/{path}
✓ Auth headers match deployer pattern (X-N8N-API-KEY)

## Next Phase Readiness

**Phase 05.3-02 (Test Harness)** can now:
- Deploy workflows with webhook triggers (using existing deployer)
- Trigger execution via triggerWebhook()
- Poll for completion via pollExecution()
- Assert on node outputs via extractNodeData()
- Clean up via deleteWorkflow()

**Blockers/Concerns:**
- Webhook registration requires workflow activation — test harness must activate workflows after deployment
- Webhooks might not register immediately — may need retry logic or delay after activation
- Test workflows must use Webhook triggers, not Manual Trigger (limitation of n8n public API)

**Recommendations for 05.3-02:**
1. Deploy workflows with Webhook triggers
2. Activate workflows after deployment (deployer supports this)
3. Add small delay (1-2s) after activation before triggering webhook (allow registration)
4. Use extractNodeData() for assertions
5. Delete workflows in afterAll cleanup

## Decisions Made

| Decision | Rationale | Impact |
|----------|-----------|--------|
| Webhook-based execution | Manual Trigger not supported by n8n public API v1 | Test workflows must use Webhook triggers |
| ?includeData=true parameter | Default response omits node output data | All getExecution calls include this parameter |
| extractNodeData() helper | Flatten complex nested execution data | Simpler test assertions |
| Polling with timeout | Execution completion is async | Configurable poll interval and timeout |
| Env var fallback pattern | Consistency with deployer module | options > env > defaults for all config |

## Files Changed

### Created
- `src/executor/types.ts` (173 lines) — Execution data types
- `src/executor/execute.ts` (224 lines) — Core execution functions

### Modified
None — new module, no existing code touched

## Task Breakdown

| Task | Description | Commit | Duration |
|------|-------------|--------|----------|
| 1 | Research n8n execution API | 76320d8 (combined) | ~3 min |
| 2 | Build executor module | 76320d8 | ~3 min |

**Total duration:** 6 minutes

## Metrics

- **Lines of code added:** 397
- **Functions implemented:** 5 (getExecution, pollExecution, triggerWebhook, deleteWorkflow, extractNodeData)
- **Type definitions:** 9 (ExecutionStatus, ExecutionMode, ExecutionResult, ExecutionData, NodeRunData, ExecutionError, ExecutionOptions, NodeExecutionData, + internal types)
- **API endpoints verified:** 5 (GET executions list, GET execution by ID, POST webhook, DELETE workflow, tested POST execution endpoints)
- **Test suite status:** 80 tests passing (no regressions)

## Future Considerations

1. **Internal API execution support** — If Manual Trigger execution is needed, could implement cookie-based authentication with /rest/workflows/{id}/run endpoint. Complex but possible.

2. **Webhook registration retry logic** — If webhook registration is unreliable, could add polling to check if webhook is registered before triggering.

3. **Test mode webhooks** — Could support /webhook-test/{path} for development/testing (requires manual "Execute workflow" click).

4. **Execution streaming** — Could add callback-based polling for progress updates (e.g., `pollExecution(id, { onUpdate: (execution) => console.log(execution.status) })`).

5. **Batch execution** — Could add helper to execute multiple workflows in parallel and wait for all.

6. **Execution data caching** — If polling the same execution multiple times, could cache responses to reduce API calls.

These are not blockers — current implementation satisfies Phase 05.3 requirements for automated workflow testing.
